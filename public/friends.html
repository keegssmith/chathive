<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Friends - ChatHive</title>
  <link rel="stylesheet" href="style.css" />
  <script type="importmap">
    {
      "imports": {
        "firebase/app": "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js"
      }
    }
  </script>
</head>
<body>
  <header id="main-header">
    <a href="index.html">
      <img src="chat-hive-logo.png" alt="Chat Hive Logo" id="chat-hive-logo">
    </a>
  </header>

  <!-- Menu Button and Dropdown -->
  <div class="menu-container">
    <button id="menu-button">
      <img src="hive-menu.png" alt="Menu" />
    </button>
    <div id="menu-dropdown" class="hidden">
      <button class="dropdown-item" id="home-button" onclick="location.href='index.html'">Home</button>
      <button class="dropdown-item" id="logout-button">Logout</button>
    </div>
  </div>

  <div id="friends-page" class="friends-container">
    <h2>Your Hive</h2>

    <form id="add-friend-form">
      <input type="text" id="friend-name" placeholder="Enter email..." required />
      <button type="submit">Send Friend Request</button>
    </form>

    <h3>Pending Requests</h3>
    <ul id="incoming-requests"></ul>

    <h3>Sent Requests</h3>
    <ul id="outgoing-requests"></ul>

    <h3>Friends</h3>
    <ul id="friends-list"></ul>
  </div>

  <script type="module">
    import { auth, db } from "./app.js";
    import { onAuthStateChanged, signOut } from "firebase/auth";
    import {
      doc, getDoc, setDoc, updateDoc, query,
      where, collection, getDocs, arrayUnion, arrayRemove
    } from "firebase/firestore";

    // Friend list rendering and logic
    const form = document.getElementById('add-friend-form');
    const input = document.getElementById('friend-name');
    const friendsList = document.getElementById('friends-list');
    const requestList = document.getElementById('incoming-requests');
    const outgoingList = document.getElementById('outgoing-requests');

    let currentUserRef = null;
    let currentUserEmail = null;

    function renderFriend(email) {
      const li = document.createElement("li");
      li.className = "friend-item";
      const nameSpan = document.createElement("span");
      nameSpan.className = "friend-name";
      nameSpan.textContent = email;
      const removeBtn = document.createElement("button");
      removeBtn.textContent = "Remove";
      removeBtn.className = "remove-btn";
      removeBtn.onclick = () => removeFriend(email);
      const actions = document.createElement("div");
      actions.className = "friend-actions";
      actions.appendChild(removeBtn);
      li.appendChild(nameSpan);
      li.appendChild(actions);
      friendsList.appendChild(li);
    }

    async function removeFriend(email) {
      if (!confirm(`Remove ${email} from friends?`)) return;
      const userSnap = await getDoc(currentUserRef);
      const userData = userSnap.data();
      await updateDoc(currentUserRef, { friends: arrayRemove(email) });
      const friendDoc = await userExistsByEmail(email);
      if (friendDoc) await updateDoc(friendDoc.ref, { friends: arrayRemove(currentUserEmail) });
      alert(`${email} removed.`);
      location.reload();
    }

    function renderRequest(email) {
      const li = document.createElement("li");
      li.className = "friend-item";
      const span = document.createElement("span");
      span.className = "friend-name";
      span.textContent = email;
      const actions = document.createElement("div");
      actions.className = "friend-actions";
      const acceptBtn = document.createElement("button");
      acceptBtn.textContent = "Accept";
      acceptBtn.className = "friend-btn";
      acceptBtn.onclick = () => acceptRequest(email);
      const declineBtn = document.createElement("button");
      declineBtn.textContent = "Decline";
      declineBtn.className = "friend-btn";
      declineBtn.onclick = () => declineRequest(email);
      actions.append(acceptBtn, declineBtn);
      li.append(span, actions);
      requestList.appendChild(li);
    }

    function renderOutgoing(email) {
      const li = document.createElement("li");
      li.className = "friend-item";
      const span = document.createElement("span");
      span.className = "friend-name";
      span.textContent = `${email} (Pending...)`;
      li.appendChild(span);
      outgoingList.appendChild(li);
    }

    async function userExistsByEmail(email) {
      const q = query(collection(db, "users"), where("email", "==", email));
      const snap = await getDocs(q);
      return snap.empty ? null : snap.docs[0];
    }

    async function acceptRequest(senderEmail) {
      const userSnap = await getDoc(currentUserRef);
      const userData = userSnap.data();
      await updateDoc(currentUserRef, {
        friends: arrayUnion(senderEmail),
        friendRequests: { incoming: arrayRemove(senderEmail) }
      });
      const senderDoc = await userExistsByEmail(senderEmail);
      if (senderDoc) {
        await updateDoc(senderDoc.ref, {
          friends: arrayUnion(currentUserEmail),
          friendRequests: { outgoing: arrayRemove(currentUserEmail) }
        });
      }
      location.reload();
    }

    async function declineRequest(senderEmail) {
      await updateDoc(currentUserRef, { friendRequests: { incoming: arrayRemove(senderEmail) } });
      const senderDoc = await userExistsByEmail(senderEmail);
      if (senderDoc) await updateDoc(senderDoc.ref, { friendRequests: { outgoing: arrayRemove(currentUserEmail) } });
      location.reload();
    }

    // Dropdown menu functionality
    function setupDropdownMenu() {
      const menuButton = document.getElementById("menu-button");
      const menuDropdown = document.getElementById("menu-dropdown");
      menuButton.addEventListener("click", (e) => {
        e.stopPropagation();
        menuDropdown.classList.toggle("hidden");
      });
      document.addEventListener("click", (e) => {
        if (!menuButton.contains(e.target) && !menuDropdown.contains(e.target)) {
          menuDropdown.classList.add("hidden");
        }
      });
    }

    function setupLogoutButton() {
      const logoutBtn = document.getElementById("logout-button");
      logoutBtn.addEventListener("click", () => {
        signOut(auth)
          .then(() => alert("Logged out successfully!"))
          .catch(err => alert(err.message));
      });
    }

    // Initialize on DOM load
    document.addEventListener("DOMContentLoaded", () => {
      setupDropdownMenu();
      setupLogoutButton();

      onAuthStateChanged(auth, async (user) => {
        if (!user) {
          window.location.href = "auth.html";
          return;
        }
        currentUserEmail = user.email;
        currentUserRef = doc(db, "users", user.uid);
        const snap = await getDoc(currentUserRef);
        const data = snap.data();
        (data.friendRequests?.incoming || []).forEach(renderRequest);
        (data.friendRequests?.outgoing || []).forEach(renderOutgoing);
        (data.friends || []).forEach(renderFriend);
      });

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const email = input.value.trim().toLowerCase();
        if (!email || email === currentUserEmail) return alert("Invalid email");
        const target = await userExistsByEmail(email);
        if (!target) return alert("User not found");
        const snap = await getDoc(currentUserRef);
        const reqs = snap.data().friendRequests || { incoming: [], outgoing: [] };
        if (reqs.outgoing.includes(email)) return alert("Request already sent");
        await updateDoc(currentUserRef, { friendRequests: { ...reqs, outgoing: arrayUnion(email) } });
        await updateDoc(target.ref, { friendRequests: { ...(target.data().friendRequests||{}), incoming: arrayUnion(currentUserEmail) } });
        renderOutgoing(email);
        input.value = "";
      });
    });
  </script>
</body>
</html>
